local Lighting = game["Lighting"]
local Environment = game["Environment"]

-- Timing 
local DAY_SECONDS = 12 * 60  -- 720 seconds, (12 minutes)
local NIGHT_SECONDS = 8 * 60 -- 480 seconds, (8 minutes)
local FADE_SECONDS = 1.0
local STEP_SECONDS = 0.05

-- Lighting
local DAY_BRIGHTNESS = 1.00
local NIGHT_BRIGHTNESS = 0.22

local DAY_SUN_COLOR = { 1.00, 1.00, 0.97, 1.00 }
local NIGHT_SUN_COLOR = { 0.28, 0.38, 0.62, 1.00 }

local DAY_AMBIENT_COLOR = { 0.70, 0.70, 0.72, 1.00 }
local NIGHT_AMBIENT_COLOR = { 0.32, 0.36, 0.45, 1.00 } 

-- Fog
local ENABLE_FOG = true

local DAY_FOG_COLOR = { 0.80, 0.86, 0.95, 1.00 }
local NIGHT_FOG_COLOR = { 0.00, 0.01, 0.04, 1.00 }

local DAY_FOG_START, DAY_FOG_END = 260, 1200
local NIGHT_FOG_START, NIGHT_FOG_END = 12, 90

-- ------------------------------------------------------------

Lighting.AmbientSource = AmbientSource.AmbientColor
Lighting.Shadows = true

local function clamp01(x)
	if x < 0 then return 0 end
	if x > 1 then return 1 end
	return x
end

local function lerp(a, b, t)
	return a + (b - a) * t
end

local function lerpColor(a, b, t)
	return Color.New(
		lerp(a[1], b[1], t),
		lerp(a[2], b[2], t),
		lerp(a[3], b[3], t),
		lerp(a[4], b[4], t)
	)
end

local function applyLighting(sunColor, ambientColor, sunBrightness)
	Lighting.SunColor = sunColor
	Lighting.AmbientColor = ambientColor
	Lighting.SunBrightness = sunBrightness
end

local function applyFog(color, startDist, endDist)
	if not (ENABLE_FOG and Environment) then return end
	Environment.FogEnabled = true
	Environment.FogColor = color
	Environment.FogStartDistance = startDist
	Environment.FogEndDistance = endDist
end

local function getSkyboxPreset(name)
	local ok, preset = pcall(function()
		return SkyboxPreset[name]
	end)
	if ok then return preset end
	return nil
end

local function pickFirstPreset(names)
	for _, name in ipairs(names) do
		local preset = getSkyboxPreset(name)
		if preset ~= nil then
			return preset
		end
	end
	return nil
end

local DAY_SKYBOX = pickFirstPreset({ "Day1", "Day2", "Day", "ClearDay", "SunnyDay" })
local NIGHT_SKYBOX = pickFirstPreset({ "Night3", "Night2", "Night1", "Night", "DarkNight", "Midnight" })

local function setSkybox(preset)
	if preset == nil then return end
	pcall(function()
		Environment.Skybox = preset
	end)
end

local function fade(
	fromSun, toSun,
	fromAmbient, toAmbient,
	fromBright, toBright,
	fromFog, toFog,
	fromFogStart, toFogStart,
	fromFogEnd, toFogEnd
)
	local step = math.max(STEP_SECONDS, 0.02)
	local duration = math.max(FADE_SECONDS, 0.01)

	local t = 0
	while t < duration do
		local a = clamp01(t / duration)

		applyLighting(
			lerpColor(fromSun, toSun, a),
			lerpColor(fromAmbient, toAmbient, a),
			lerp(fromBright, toBright, a)
		)

		applyFog(
			lerpColor(fromFog, toFog, a),
			lerp(fromFogStart, toFogStart, a),
			lerp(fromFogEnd, toFogEnd, a)
		)

		wait(step)
		t = t + step
	end
end

while true do
	-- Day
	setSkybox(DAY_SKYBOX)
	applyLighting(
		Color.New(DAY_SUN_COLOR[1], DAY_SUN_COLOR[2], DAY_SUN_COLOR[3], DAY_SUN_COLOR[4]),
		Color.New(DAY_AMBIENT_COLOR[1], DAY_AMBIENT_COLOR[2], DAY_AMBIENT_COLOR[3], DAY_AMBIENT_COLOR[4]),
		DAY_BRIGHTNESS
	)
	applyFog(
		Color.New(DAY_FOG_COLOR[1], DAY_FOG_COLOR[2], DAY_FOG_COLOR[3], DAY_FOG_COLOR[4]),
		DAY_FOG_START, DAY_FOG_END
	)
	wait(DAY_SECONDS)

	-- Day -> Night
	setSkybox(NIGHT_SKYBOX)
	fade(
		DAY_SUN_COLOR, NIGHT_SUN_COLOR,
		DAY_AMBIENT_COLOR, NIGHT_AMBIENT_COLOR,
		DAY_BRIGHTNESS, NIGHT_BRIGHTNESS,
		DAY_FOG_COLOR, NIGHT_FOG_COLOR,
		DAY_FOG_START, NIGHT_FOG_START,
		DAY_FOG_END, NIGHT_FOG_END
	)

	-- Night
	applyLighting(
		Color.New(NIGHT_SUN_COLOR[1], NIGHT_SUN_COLOR[2], NIGHT_SUN_COLOR[3], NIGHT_SUN_COLOR[4]),
		Color.New(NIGHT_AMBIENT_COLOR[1], NIGHT_AMBIENT_COLOR[2], NIGHT_AMBIENT_COLOR[3], NIGHT_AMBIENT_COLOR[4]),
		NIGHT_BRIGHTNESS
	)
	applyFog(
		Color.New(NIGHT_FOG_COLOR[1], NIGHT_FOG_COLOR[2], NIGHT_FOG_COLOR[3], NIGHT_FOG_COLOR[4]),
		NIGHT_FOG_START, NIGHT_FOG_END
	)
	wait(NIGHT_SECONDS)

	-- Night -> Day
	setSkybox(DAY_SKYBOX)
	fade(
		NIGHT_SUN_COLOR, DAY_SUN_COLOR,
		NIGHT_AMBIENT_COLOR, DAY_AMBIENT_COLOR,
		NIGHT_BRIGHTNESS, DAY_BRIGHTNESS,
		NIGHT_FOG_COLOR, DAY_FOG_COLOR,
		NIGHT_FOG_START, DAY_FOG_START,
		NIGHT_FOG_END, DAY_FOG_END
	)
end
